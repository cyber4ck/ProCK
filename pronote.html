<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nebula Notes 3D Suite</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --glass-bg: rgba(255, 255, 255, 0.1);
            --glass-strong: rgba(20, 20, 35, 0.6);
            --glass-border: rgba(255, 255, 255, 0.2);
            --accent: #764ba2;
            --text-color: #fff;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: 'Nunito', sans-serif;
            overflow: hidden;
            background: #0f0c29;
            height: 100vh;
            width: 100vw;
            color: white;
        }

        /* --- THREE.JS BACKGROUND --- */
        #bg-canvas {
            position: fixed;
            top: 0; left: 0; z-index: 0;
        }

        /* --- UI LAYER --- */
        #app-layer {
            position: relative;
            z-index: 1;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        /* --- NAVIGATION HEADER --- */
        header {
            flex-shrink: 0;
            margin: 20px auto;
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            padding: 8px 10px;
            border-radius: 50px;
            border: 1px solid var(--glass-border);
            display: flex;
            gap: 10px;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
            z-index: 2000;
            width: fit-content;
        }

        .nav-segment {
            display: flex;
            background: rgba(0,0,0,0.2);
            border-radius: 30px;
            padding: 4px;
        }

        button.nav-btn {
            background: transparent;
            border: none;
            padding: 8px 24px;
            color: rgba(255,255,255,0.6);
            font-weight: bold;
            border-radius: 25px;
            cursor: pointer;
            transition: 0.3s;
            font-family: 'Nunito', sans-serif;
        }

        button.nav-btn.active {
            background: var(--accent);
            color: white;
            box-shadow: 0 2px 10px rgba(118, 75, 162, 0.5);
        }

        .action-group {
            display: flex;
            gap: 10px;
            margin-left: 10px;
            align-items: center;
            border-left: 1px solid rgba(255,255,255,0.2);
            padding-left: 10px;
        }

        button.action-btn {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.1);
            color: white;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            cursor: pointer;
            font-size: 16px;
            transition: 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        button.action-btn:hover { background: rgba(255,255,255,0.2); transform: scale(1.1); }
        button.btn-add { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; }

        /* --- VIEW CONTAINERS --- */
        .view-container {
            flex-grow: 1;
            position: relative;
            display: none;
            opacity: 0;
            transition: opacity 0.4s ease;
            overflow: hidden;
        }

        .view-container.show {
            display: block;
            opacity: 1;
        }

        /* --- STICKY BOARD STYLES --- */
        #sticky-board {
            width: 100%;
            height: 100%;
            overflow: auto; /* Allows scrolling if notes go off screen */
            position: relative;
        }

        .note {
            position: absolute;
            width: 250px;
            height: 250px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            resize: both;
            min-width: 200px; min-height: 150px;
            animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            border: 1px solid rgba(255,255,255,0.1);
            transition: box-shadow 0.2s, transform 0.2s;
        }

        .note:hover { box-shadow: 0 15px 45px rgba(0,0,0,0.6); border-color: rgba(255,255,255,0.4); }
        
        /* Note Gradients */
        .grad-1 { background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%); color: #444; }
        .grad-2 { background: linear-gradient(120deg, #a1c4fd 0%, #c2e9fb 100%); color: #444; }
        .grad-3 { background: linear-gradient(120deg, #84fab0 0%, #8fd3f4 100%); color: #444; }
        .grad-4 { background: linear-gradient(120deg, #fccb90 0%, #d57eeb 100%); color: #fff; }

        .note-header {
            height: 32px;
            width: 100%;
            cursor: grab;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 10px;
            background: rgba(0,0,0,0.1);
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }
        .note-header:active { cursor: grabbing; background: rgba(0,0,0,0.2); }

        .drag-handle {
            font-size: 12px;
            opacity: 0.5;
            text-transform: uppercase;
            letter-spacing: 1px;
            pointer-events: none;
        }

        .delete-btn {
            background: transparent; border: none; color: inherit;
            font-weight: bold; font-size: 18px; cursor: pointer; opacity: 0.5;
            line-height: 1;
        }
        .delete-btn:hover { opacity: 1; transform: scale(1.2); color: #d00; }

        .note-body { flex-grow: 1; width: 100%; height: 100%; position: relative; }
        
        textarea.sticky-area {
            width: 100%; height: 100%;
            background: transparent; border: none; resize: none;
            padding: 12px; font-family: 'Nunito', sans-serif;
            font-size: 16px; color: inherit; outline: none;
            line-height: 1.5;
        }

        /* --- DOCUMENT EDITOR STYLES --- */
        #doc-editor {
            display: flex;
            justify-content: center;
            padding-bottom: 40px;
        }

        .paper-sheet {
            width: 800px; max-width: 90%; height: 90%;
            background: var(--glass-strong);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            display: flex; flex-direction: column;
            animation: slideUp 0.5s ease-out;
        }

        .paper-header {
            padding: 15px 30px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex; justify-content: space-between;
            color: rgba(255,255,255,0.7); font-size: 14px;
        }

        .doc-area {
            flex-grow: 1; width: 100%; background: transparent;
            border: none; resize: none; padding: 40px 50px;
            font-family: 'Nunito', sans-serif; font-size: 18px;
            line-height: 1.6; color: #eee; outline: none; overflow-y: auto;
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 10px; height: 10px; }
        ::-webkit-scrollbar-track { background: rgba(0,0,0,0.1); }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 5px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.4); }

        /* Animations */
        @keyframes popIn { from { opacity: 0; transform: scale(0.8); } to { opacity: 1; transform: scale(1); } }
        @keyframes slideUp { from { opacity: 0; transform: translateY(50px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes deleteAnim { to { opacity: 0; transform: scale(0.1) rotate(10deg); } }
        
        /* Class for moving animation during arrange */
        .moving-note { transition: top 0.5s ease, left 0.5s ease; }
        .deleting { animation: deleteAnim 0.3s forwards; }

        .status-msg { opacity: 0.7; transition: opacity 0.5s; }
        .faded { opacity: 0; }
    </style>
</head>
<body>

    <!-- 3D Background -->
    <canvas id="bg-canvas"></canvas>

    <!-- App UI -->
    <div id="app-layer">
        
        <!-- Navigation Header -->
        <header>
            <div class="nav-segment">
                <button class="nav-btn active" onclick="switchView('board')">Board</button>
                <button class="nav-btn" onclick="switchView('doc')">Document</button>
            </div>
            
            <div class="action-group" id="board-controls">
                <button class="action-btn btn-add" onclick="createNote()" title="Add Sticky Note">+</button>
                <button class="action-btn" onclick="autoArrange()" title="Auto Arrange Grid" style="font-size:14px">â–¦</button>
                <button class="action-btn" onclick="clearBoard()" title="Clear Board" style="background:rgba(255,80,80,0.3)">ðŸ—‘</button>
            </div>

            <div class="action-group" id="doc-controls" style="display:none;">
                <button class="action-btn" onclick="downloadDoc()" title="Download .txt">â¬‡</button>
                <button class="action-btn" onclick="clearDoc()" title="Clear Document" style="background:rgba(255,80,80,0.3)">ðŸ—‘</button>
            </div>
        </header>

        <!-- VIEW 1: Sticky Board -->
        <div id="sticky-board" class="view-container show">
            <!-- Notes injected here -->
        </div>

        <!-- VIEW 2: Full Document Editor -->
        <div id="doc-editor" class="view-container">
            <div class="paper-sheet">
                <div class="paper-header">
                    <span>Nebula Document</span>
                    <span id="save-status" class="status-msg faded">Saved</span>
                </div>
                <textarea id="main-doc" class="doc-area" placeholder="Start writing your masterpiece..."></textarea>
            </div>
        </div>

    </div>

    <script>
        /* ------------------------------------------------------------
           PART 1: THREE.JS BACKGROUND
           ------------------------------------------------------------ */
        const canvas = document.querySelector('#bg-canvas');
        const scene = new THREE.Scene();
        scene.fog = new THREE.FogExp2(0x0f0c29, 0.002);

        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ canvas: canvas, alpha: true, antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(window.devicePixelRatio);

        const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
        scene.add(ambientLight);
        const pointLight = new THREE.PointLight(0xff00ff, 1, 100);
        pointLight.position.set(10, 10, 10);
        scene.add(pointLight);

        // Background Objects
        const particles = [];
        const geometry = new THREE.TetrahedronGeometry(1, 0);

        for(let i = 0; i < 60; i++) {
            const material = new THREE.MeshStandardMaterial({ 
                color: new THREE.Color(`hsl(${Math.random() * 360}, 70%, 60%)`),
                roughness: 0.4, metalness: 0.1,
                transparent: true, opacity: 0.7
            });
            const mesh = new THREE.Mesh(geometry, material);
            mesh.position.set((Math.random()-0.5)*60, (Math.random()-0.5)*60, (Math.random()-0.5)*40 - 15);
            mesh.scale.setScalar(Math.random() * 1 + 0.3);
            mesh.userData = {
                rotX: (Math.random()-0.5)*0.015, rotY: (Math.random()-0.5)*0.015,
                yOff: Math.random()*Math.PI*2
            };
            scene.add(mesh);
            particles.push(mesh);
        }

        camera.position.z = 15;
        let mouseX = 0, mouseY = 0;
        document.addEventListener('mousemove', (e) => {
            mouseX = (e.clientX / window.innerWidth) * 2 - 1;
            mouseY = -(e.clientY / window.innerHeight) * 2 + 1;
        });

        function animate3D() {
            requestAnimationFrame(animate3D);
            particles.forEach(p => {
                p.rotation.x += p.userData.rotX;
                p.rotation.y += p.userData.rotY;
                p.position.y += Math.sin(Date.now() * 0.001 + p.userData.yOff) * 0.01;
            });
            // Subtle parallax
            camera.position.x += (mouseX * 0.5 - camera.position.x) * 0.05;
            camera.position.y += (mouseY * 0.5 - camera.position.y) * 0.05;
            camera.lookAt(scene.position);
            renderer.render(scene, camera);
        }
        animate3D();
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth/window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });


        /* ------------------------------------------------------------
           PART 2: APP LOGIC
           ------------------------------------------------------------ */
        
        // --- View Switching ---
        const boardView = document.getElementById('sticky-board');
        const docView = document.getElementById('doc-editor');
        const boardControls = document.getElementById('board-controls');
        const docControls = document.getElementById('doc-controls');
        const navBtns = document.querySelectorAll('.nav-btn');

        function switchView(viewName) {
            navBtns.forEach(btn => btn.classList.remove('active'));
            
            if(viewName === 'board') {
                navBtns[0].classList.add('active');
                boardView.classList.add('show');
                docView.classList.remove('show');
                boardControls.style.display = 'flex';
                docControls.style.display = 'none';
                setTimeout(() => { docView.style.display='none'; boardView.style.display='block'; }, 400); 
            } else {
                navBtns[1].classList.add('active');
                docView.style.display='flex';
                docView.classList.add('show');
                boardView.classList.remove('show');
                docControls.style.display = 'flex';
                boardControls.style.display = 'none';
                setTimeout(() => { boardView.style.display='none'; }, 400); 
            }
        }

        // --- Sticky Board Logic ---
        let zIndexCounter = 100;
        let notes = [];

        function initBoard() {
            const saved = JSON.parse(localStorage.getItem('nebula-notes') || '[]');
            if (saved.length > 0) {
                notes = saved;
                notes.forEach(spawnNoteDOM);
            } else {
                createNote("Drag me!", 50, 50);
                createNote("I'm customizable", 320, 50);
            }
        }

        function createNote(content="", x=null, y=null) {
            // Smart placement (if x,y not provided, slightly offset from last one)
            let posX = x;
            let posY = y;
            
            if (posX === null) {
                const last = notes[notes.length-1];
                if(last) { posX = last.x + 30; posY = last.y + 30; }
                else { posX = 50; posY = 50; }
                
                // Keep within bounds roughly
                if(posX > window.innerWidth - 300) posX = 50;
                if(posY > window.innerHeight - 300) posY = 50;
            }

            const noteObj = {
                id: Date.now(), x: posX, y: posY, content: content,
                color: `grad-${Math.floor(Math.random()*4)+1}`,
                w: 250, h: 250
            };
            notes.push(noteObj);
            spawnNoteDOM(noteObj);
            saveNotes();
        }

        function spawnNoteDOM(obj) {
            const el = document.createElement('div');
            el.className = `note ${obj.color}`;
            el.id = `n-${obj.id}`;
            el.style.left = obj.x + 'px'; el.style.top = obj.y + 'px';
            el.style.width = obj.w + 'px'; el.style.height = obj.h + 'px';
            el.style.zIndex = zIndexCounter++;

            el.innerHTML = `
                <div class="note-header">
                    <span class="drag-handle">:::</span>
                    <button class="delete-btn" onclick="delNote(${obj.id})">&times;</button>
                </div>
                <div class="note-body"><textarea class="sticky-area" oninput="updNote(${obj.id}, this.value)">${obj.content}</textarea></div>
            `;

            // Drag Interaction
            const header = el.querySelector('.note-header');
            let isDrag = false, offX, offY;
            
            // Mouse Down on Header
            header.addEventListener('mousedown', (e) => {
                isDrag = true;
                offX = e.clientX - el.offsetLeft;
                offY = e.clientY - el.offsetTop;
                el.style.zIndex = ++zIndexCounter; // Bring to front
                el.classList.remove('moving-note'); // Disable transition during drag
                header.style.cursor = 'grabbing';
            });

            // Global Move
            window.addEventListener('mousemove', (e) => {
                if(!isDrag) return;
                
                // Calculate new position
                let newX = e.clientX - offX;
                let newY = e.clientY - offY;

                // Boundary Checks (Keep inside top/left, allow scrolling right/bottom)
                newX = Math.max(0, newX); 
                newY = Math.max(0, newY);

                el.style.left = newX + 'px';
                el.style.top = newY + 'px';
            });

            // Global Up
            window.addEventListener('mouseup', () => {
                if(isDrag) {
                    isDrag = false; header.style.cursor = 'grab';
                    const n = notes.find(x => x.id === obj.id);
                    if(n) { n.x = parseInt(el.style.left); n.y = parseInt(el.style.top); saveNotes(); }
                }
            });

            // Note click (bring to front)
            el.addEventListener('mousedown', () => el.style.zIndex = ++zIndexCounter);

            // Resize Observer
            new ResizeObserver(entries => {
                const n = notes.find(x => x.id === obj.id);
                if(n && !isDrag) { // Only save if not currently dragging (optimization)
                    n.w = entries[0].contentRect.width;
                    n.h = entries[0].contentRect.height + 32; 
                    saveNotes();
                }
            }).observe(el);

            boardView.appendChild(el);
        }

        // --- The "Clean up the Mess" Function ---
        function autoArrange() {
            const margin = 20;
            const containerWidth = boardView.clientWidth;
            let currentX = margin;
            let currentY = margin;
            let maxHeightInRow = 0;

            notes.forEach(note => {
                const el = document.getElementById(`n-${note.id}`);
                
                // Check if next note fits in row
                if (currentX + note.w + margin > containerWidth) {
                    currentX = margin;
                    currentY += maxHeightInRow + margin;
                    maxHeightInRow = 0;
                }

                // Apply new coords
                note.x = currentX;
                note.y = currentY;

                // Update DOM with animation class
                el.classList.add('moving-note');
                el.style.left = currentX + 'px';
                el.style.top = currentY + 'px';

                // Prepare next position
                currentX += note.w + margin;
                if (note.h > maxHeightInRow) maxHeightInRow = note.h;
            });

            // Save new positions after delay
            setTimeout(saveNotes, 600);
        }

        function updNote(id, txt) {
            const n = notes.find(x => x.id === id);
            if(n) { n.content = txt; saveNotes(); }
        }

        function delNote(id) {
            const el = document.getElementById(`n-${id}`);
            el.classList.add('deleting');
            setTimeout(() => { el.remove(); notes = notes.filter(n=>n.id!==id); saveNotes(); }, 300);
        }

        function clearBoard() {
            if(confirm("Delete all sticky notes?")) {
                notes = [];
                document.querySelectorAll('.note').forEach(e => e.remove());
                saveNotes();
            }
        }
        
        function saveNotes() { localStorage.setItem('nebula-notes', JSON.stringify(notes)); }


        // --- Document Editor Logic ---
        const docArea = document.getElementById('main-doc');
        const statusMsg = document.getElementById('save-status');
        let typeTimeout;

        function initDoc() {
            docArea.value = localStorage.getItem('nebula-doc-content') || '';
            docArea.addEventListener('input', () => {
                statusMsg.classList.add('faded');
                clearTimeout(typeTimeout);
                typeTimeout = setTimeout(() => {
                    localStorage.setItem('nebula-doc-content', docArea.value);
                    statusMsg.textContent = "Saved";
                    statusMsg.classList.remove('faded');
                }, 1000);
            });
        }

        function clearDoc() {
            if(confirm("Clear the entire document?")) {
                docArea.value = "";
                localStorage.setItem('nebula-doc-content', "");
            }
        }

        function downloadDoc() {
            const blob = new Blob([docArea.value], { type: "text/plain" });
            const anchor = document.createElement("a");
            anchor.href = URL.createObjectURL(blob);
            anchor.download = "nebula-document.txt";
            anchor.click();
        }

        // Initialize App
        window.onload = () => {
            initBoard();
            initDoc();
        };

    </script>
</body>
</html>
